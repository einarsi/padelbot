<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PadelBot Log and Event Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #eee; margin: 0; padding: 1em; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
        .container { display: flex; gap: 1em; }
        .log-section { flex: 2; }
        .events-section { flex: 1; background: #111; padding: 1em; border-radius: 8px; max-height: 80vh; overflow-y: auto; }
        #log { white-space: pre-wrap; background: #111; padding: 1em; border-radius: 8px; max-height: 80vh; overflow-y: auto; font-size: 1em; }
        .timestamp { color: #7fd8ff; }
        .level-info { color: #b2ffb2; }
        .level-warning { color: #ffe066; }
        .level-error { color: #ff7f7f; }
        .level-debug { color: #b2b2ff; }
        .refresh-btn { padding: 0.5em 1em; background: #444; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .refresh-btn:hover { background: #666; }
        .event-card { background: #1a1a1a; padding: 0.8em; margin-bottom: 1em; border-radius: 4px; border-left: 3px solid #7fd8ff; }
        .event-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.5em; }
        .event-title { color: #7fd8ff; font-weight: bold; font-size: 1.1em; }
        .event-time { color: #999; font-size: 0.9em; }
        .participant-section { margin-top: 0.5em; }
        .participant-label { color: #b2ffb2; font-weight: bold; font-size: 0.95em; }
        .participant-list { color: #ddd; font-size: 0.85em; margin-left: 0.5em; }
        .accepted-list { font-size: 1em; }
        .waitinglist-label { color: #ffe066; }
        .declined-label { color: #ff7f7f; }
        .unanswered-label { color: #999; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h2 style="margin: 0;">PadelBot Log and Event Viewer</h2>
            <button class="refresh-btn" @click="fetchLog">Refresh Log</button>
        </div>
        <div class="container">
            <div class="log-section">
                <div id="log" ref="logDiv">
                    <div v-html="colorizedLog"></div>
                </div>
            </div>
            <div class="events-section">
                <div v-if="events.length === 0" style="color: #999;">Loading...</div>
                <div v-for="event in events" :key="event.heading" class="event-card">
                    <div class="event-header">
                        <div class="event-title">{{ event.heading }}</div>
                        <div class="event-time">{{ formatTime(event.startTimestamp, event.endTimestamp) }}</div>
                    </div>
                    <div class="participant-section" v-if="event.accepted.length > 0">
                        <div class="participant-label">Accepted ({{ event.accepted.length }}):</div>
                        <div class="participant-list accepted-list">
                            <div v-for="(name, index) in event.accepted" :key="index">
                                {{ index + 1 }}. {{ name }}
                            </div>
                        </div>
                    </div>
                    <div class="participant-section" v-if="event.waitinglist.length > 0">
                        <div class="participant-label waitinglist-label">Waitinglist ({{ event.waitinglist.length }}):</div>
                        <div class="participant-list">{{ event.waitinglist.join(', ') }}</div>
                    </div>
                    <div class="participant-section" v-if="event.unconfirmed.length > 0">
                        <div class="participant-label">Unconfirmed ({{ event.unconfirmed.length }}):</div>
                        <div class="participant-list">{{ event.unconfirmed.join(', ') }}</div>
                    </div>
                    <div class="participant-section" v-if="event.declined.length > 0">
                        <div class="participant-label declined-label">Declined ({{ event.declined.length }}):</div>
                        <div class="participant-list">{{ event.declined.join(', ') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    const { createApp } = Vue;
    createApp({
        data() {
            return { log: '', events: [] }
        },
        computed: {
            colorizedLog() {
                if (!this.log) return '';
                // Split log into lines and colorize
                return this.log.split('\n').map(line => {
                    // Match timestamp with timezone offset (e.g., 2025-09-26 12:34:56+0100 or 2025-09-26 12:34:56+01:00)
                    const tsMatch = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}[+-]\d{2}:?\d{2})/);
                    let html = line;
                    if (tsMatch) {
                        html = html.replace(tsMatch[1], `<span class='timestamp'>${tsMatch[1]}</span>`);
                    }
                    // Match log level
                    if (/INFO/.test(line)) {
                        html = html.replace(/INFO/, `<span class='level-info'>INFO</span>`);
                    } else if (/WARNING/.test(line)) {
                        html = html.replace(/WARNING/, `<span class='level-warning'>WARNING</span>`);
                    } else if (/ERROR/.test(line)) {
                        html = html.replace(/ERROR/, `<span class='level-error'>ERROR</span>`);
                    } else if (/DEBUG/.test(line)) {
                        html = html.replace(/DEBUG/, `<span class='level-debug'>DEBUG</span>`);
                    }
                    return html;
                }).join('<br>');
            }
        },
        mounted() {
            this.fetchLog();
            this.fetchEvents();
            setInterval(this.fetchLog, 10000);
            setInterval(this.fetchEvents, 30000);
            this.$nextTick(this.scrollToBottom);
        },
        updated() {
            this.$nextTick(this.scrollToBottom);
        },
        methods: {
            fetchLog() {
                fetch('/logs').then(r => r.text()).then(t => { this.log = t });
            },
            fetchEvents() {
                fetch('/events').then(r => r.json()).then(data => { 
                    if (data.events) this.events = data.events; 
                }).catch(e => console.error('Error fetching events:', e));
            },
            scrollToBottom() {
                const logDiv = this.$refs.logDiv;
                if (logDiv) {
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
            },
            formatTime(startTimestamp, endTimestamp) {
                if (!startTimestamp) return '';
                const startDate = new Date(startTimestamp);
                
                const weekday = startDate.toLocaleDateString('en-GB', { weekday: 'short' });
                const year = startDate.getFullYear();
                const month = String(startDate.getMonth() + 1).padStart(2, '0');
                const day = String(startDate.getDate()).padStart(2, '0');
                const startTime = startDate.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let result = `${weekday} ${year}-${month}-${day} ${startTime}`;
                
                if (endTimestamp) {
                    const endDate = new Date(endTimestamp);
                    const endTime = endDate.toLocaleTimeString('en-GB', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    result += `-${endTime}`;
                }
                
                return result;
            }
        }
    }).mount('#app');
    </script>
</body>
</html>
